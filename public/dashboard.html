<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aroodes Dashboard - Lord of the Mysteries</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'IM Fell English', serif;
      background: linear-gradient(135deg, #0a0612, #1a0a2e, #16213e);
      background-size: 400% 400%;
      animation: gradientShift 20s ease infinite;
      color: #e9e9e9;
      min-height: 100vh;
    }
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .title-font { font-family: 'Cinzel Decorative', serif; }
    .glass {
      background: rgba(20, 20, 40, 0.9);
      backdrop-filter: blur(12px);
      border: 2px solid #d4af37;
      box-shadow: 0 8px 32px rgba(212, 175, 55, 0.2);
    }
    .pathway-card:hover {
      transform: translateY(-10px) scale(1.05);
      box-shadow: 0 20px 40px rgba(212, 175, 55, 0.5);
    }
    .profile-img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid #d4af37;
    }
  </style>
</head>
<body>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_BASE = window.location.origin + '/api';

    const PATHWAYS = [
      { id: 'fool', name: 'The Fool', image: '/pathways/fool.png', desc: 'Cunning, Deception, Miracles' },
      { id: 'error', name: 'Error', image: '/pathways/error.png', desc: 'Fate, Probability, Parasites' },
      { id: 'door', name: 'Door', image: '/pathways/door.png.webp', desc: 'Space, Teleportation' },
      { id: 'visionary', name: 'Visionary', image: '/pathways/visionary.png.webp', desc: 'Mind, Dragons' },
      { id: 'sun', name: 'The Sun', image: '/pathways/sun.png.webp', desc: 'Light, Purification' },
      { id: 'tyrant', name: 'Tyrant', image: '/pathways/tyrant.png.webp', desc: 'Lightning, Storms' },
      { id: 'death', name: 'Death', image: '/pathways/death.png', desc: 'Undead, Spirits' },
      { id: 'moon', name: 'The Moon', image: '/pathways/moon.png', desc: 'Madness, Beauty' },
      { id: 'red_priest', name: 'Red Priest', image: '/pathways/red_priest.png', desc: 'War, Strategy' },
      { id: 'demoness', name: 'Demoness', image: '/pathways/demoness.png.webp', desc: 'Beauty, Calamity' },
      { id: 'hanged_man', name: 'Hanged Man', image: '/pathways/hanged_man.png', desc: 'Sea, Storms' },
      { id: 'darkness', name: 'Darkness', image: '/pathways/darkness.png.webp', desc: 'Shadows, Stealth' },
      { id: 'twilight', name: 'Twilight Giant', image: '/pathways/twilight_giant.png.webp', desc: 'Giants, Dawn' },
      { id: 'white_tower', name: 'White Tower', image: '/pathways/white_tower.png.webp', desc: 'Knowledge' },
      { id: 'mother', name: 'Mother', image: '/pathways/mother.png.webp', desc: 'Earth, Harvest' },
      { id: 'abyss', name: 'Abyss', image: '/pathways/abyss.png.webp', desc: 'Evil, Desire' },
      { id: 'chained', name: 'Chained', image: '/pathways/chained.png.webp', desc: 'Temperance' },
      { id: 'justiciar', name: 'Justiciar', image: '/pathways/justiciar.png.webp', desc: 'Order, Law' },
      { id: 'paragon', name: 'Paragon', image: '/pathways/paragon.png.webp', desc: 'Crafting' },
      { id: 'black_emperor', name: 'Black Emperor', image: '/pathways/black_emperor.png.webp', desc: 'Order, Rules' },
      { id: 'hermit', name: 'The Hermit', image: '/pathways/hermit.png.webp', desc: 'Knowledge' },
      { id: 'wheel', name: 'Wheel of Fortune', image: '/pathways/wheel_of_fortune.png.webp', desc: 'Luck, Monsters' }
    ];

    function App() {
      const [user, setUser] = useState(null);
      const [activeTab, setActiveTab] = useState('home');
      const [stats, setStats] = useState(null);
      const [beyonders, setBeyonders] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetchData();
        const interval = setInterval(fetchData, 30000);
        return () => clearInterval(interval);
      }, []);

      const fetchData = async () => {
        try {
          console.log('üîÑ Fetching data...');
          
          // Fetch user
          const userRes = await fetch(`${API_BASE}/me`).catch(() => null);
          if (userRes && userRes.ok) {
            const userData = await userRes.json();
            console.log('üë§ User:', userData);
            setUser(userData);
          }

          // Fetch stats
          const statsRes = await fetch(`${API_BASE}/stats`);
          const statsData = await statsRes.json();
          console.log('üìä Stats:', statsData);
          setStats(statsData);

          // Fetch beyonders
          const beyondersRes = await fetch(`${API_BASE}/beyonders`);
          const beyondersData = await beyondersRes.json();
          console.log('üë• Beyonders:', beyondersData);
          setBeyonders(Array.isArray(beyondersData) ? beyondersData : []);

          setLoading(false);
        } catch (error) {
          console.error('‚ùå Error:', error);
          setLoading(false);
        }
      };

      const getDiscordAvatar = (userId, avatar) => {
        if (!userId || !avatar) return 'https://cdn.discordapp.com/embed/avatars/0.png';
        return `https://cdn.discordapp.com/avatars/${userId}/${avatar}.png?size=128`;
      };

      return (
        <div className="min-h-screen">
          <Navbar user={user} getDiscordAvatar={getDiscordAvatar} activeTab={activeTab} setActiveTab={setActiveTab} />
          
          <main className="max-w-7xl mx-auto px-4 py-8">
            {loading ? (
              <div className="text-center py-32">
                <div className="text-8xl mb-8 animate-pulse">üåô</div>
                <div className="text-4xl text-primary title-font">Loading...</div>
              </div>
            ) : (
              <>
                {activeTab === 'home' && <Home user={user} stats={stats} beyonders={beyonders} />}
                {activeTab === 'pathways' && <PathwaySelection user={user} pathways={PATHWAYS} onRefresh={fetchData} />}
                {activeTab === 'games' && <Games user={user} onRefresh={fetchData} />}
                {activeTab === 'beyonders' && <Beyonders beyonders={beyonders} getDiscordAvatar={getDiscordAvatar} />}
              </>
            )}
          </main>
        </div>
      );
    }

    function Navbar({ user, getDiscordAvatar, activeTab, setActiveTab }) {
      return (
        <nav className="glass sticky top-0 z-50">
          <div className="max-w-7xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-4">
                <div className="text-4xl">üåô</div>
                <div>
                  <h1 className="text-2xl md:text-3xl title-font" style={{color: '#d4af37'}}>Aroodes</h1>
                  <p className="text-xs text-gray-400 hidden md:block">Above the Gray Fog</p>
                </div>
              </div>

              {user && (
                <div className="flex items-center gap-4 glass px-4 py-2 rounded-lg">
                  <div className="text-right hidden md:block">
                    <div className="font-bold" style={{color: '#d4af37'}}>{user.username}</div>
                    <div className="text-xs text-gray-400 capitalize">
                      {user.pathway || 'No Pathway'} ‚Ä¢ Seq {user.sequence || 9}
                    </div>
                  </div>
                  <img 
                    src={getDiscordAvatar(user.id, user.avatar)} 
                    alt={user.username}
                    className="profile-img"
                  />
                </div>
              )}

              <div className="hidden md:flex gap-2">
                {['home', 'pathways', 'games', 'beyonders'].map(tab => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`px-4 py-2 rounded-lg transition capitalize ${
                      activeTab === tab ? 'bg-yellow-600 text-black font-bold' : 'hover:bg-yellow-600/20'
                    }`}
                  >
                    {tab}
                  </button>
                ))}
                {!user ? (
                  <a href="/login" className="px-4 py-2 rounded-lg bg-yellow-600 text-black font-bold">Login</a>
                ) : (
                  <a href="/logout" className="px-4 py-2 rounded-lg bg-red-500/20">Logout</a>
                )}
              </div>
            </div>
          </div>
        </nav>
      );
    }

    function Home({ user, stats, beyonders }) {
      return (
        <div className="space-y-12">
          <div className="text-center">
            <h1 className="text-5xl md:text-7xl title-font mb-4" style={{color: '#d4af37'}}>
              Welcome to Aroodes
            </h1>
            <p className="text-xl italic text-gray-300 max-w-3xl mx-auto">
              Choose your pathway, complete games, earn spiritual points, and ascend to godhood!
            </p>
            {!user && (
              <div className="mt-8">
                <a href="/login" className="inline-block px-12 py-4 bg-gradient-to-r from-yellow-600 to-yellow-500 text-black font-bold text-xl rounded-xl">
                  Begin Your Journey
                </a>
              </div>
            )}
          </div>

          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            <StatCard icon="üîÆ" title="Total Beyonders" value={stats?.totalBeyonders || beyonders.length || 0} />
            <StatCard icon="üëº" title="Angels" value={stats?.angels || 0} />
            <StatCard icon="‚öúÔ∏è" title="True Gods" value={stats?.trueGods || 0} />
            <StatCard icon="üé≠" title="Pathways" value="22" />
          </div>

          {user && (
            <div className="glass rounded-2xl p-8">
              <h2 className="text-3xl title-font mb-6" style={{color: '#d4af37'}}>Your Progress</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <div className="text-gray-400 mb-2">Pathway</div>
                  <div className="text-2xl font-bold capitalize" style={{color: '#d4af37'}}>
                    {user.pathway || 'Not Selected'}
                  </div>
                </div>
                <div>
                  <div className="text-gray-400 mb-2">Sequence</div>
                  <div className="text-2xl font-bold" style={{color: '#d4af37'}}>{user.sequence || 9}</div>
                </div>
                <div>
                  <div className="text-gray-400 mb-2">Spiritual Points</div>
                  <div className="text-2xl font-bold" style={{color: '#d4af37'}}>{user.spiritualPoints || 0}</div>
                </div>
              </div>
            </div>
          )}

          {beyonders.length > 0 && (
            <div>
              <h2 className="text-3xl title-font mb-6 text-center" style={{color: '#d4af37'}}>
                Recent Beyonders
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {beyonders.slice(0, 6).map(b => (
                  <div key={b.user_id} className="glass rounded-xl p-6">
                    <h3 className="font-bold mb-2">{b.username}</h3>
                    <div className="text-sm space-y-1">
                      <div>Pathway: <span className="text-primary capitalize">{b.pathway || 'None'}</span></div>
                      <div>Sequence: <span className="text-primary">{b.sequence}</span></div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    function PathwaySelection({ user, pathways, onRefresh }) {
      const [selecting, setSelecting] = useState(false);
      const [selectedPathway, setSelectedPathway] = useState(null);

      const selectPathway = async (pathwayId) => {
        if (!user) {
          alert('Please login first!');
          window.location.href = '/login';
          return;
        }

        if (user.pathway) {
          alert('You already have a pathway selected!');
          return;
        }

        setSelecting(true);
        try {
          const response = await fetch('/api/select-pathway', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pathwayId })
          });

          if (response.ok) {
            alert('Pathway selected successfully!');
            onRefresh();
          } else {
            alert('Failed to select pathway');
          }
        } catch (error) {
          alert('Error selecting pathway');
        }
        setSelecting(false);
      };

      return (
        <div className="space-y-8">
          <div className="text-center">
            <h2 className="text-4xl title-font mb-4" style={{color: '#d4af37'}}>
              Choose Your Pathway
            </h2>
            <p className="text-gray-300 italic">
              {user?.pathway 
                ? `You've selected: ${user.pathway.toUpperCase()}`
                : 'Select your beyonder pathway to begin your journey'
              }
            </p>
          </div>

          <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
            {pathways.map(pathway => (
              <div
                key={pathway.id}
                onClick={() => !user?.pathway && setSelectedPathway(pathway)}
                className="pathway-card glass rounded-xl p-4 cursor-pointer transition-all duration-300"
              >
                <div className="h-32 mb-3 bg-black/30 rounded-lg overflow-hidden flex items-center justify-center">
                  <img src={pathway.image} alt={pathway.name} className="max-w-full max-h-full object-contain" />
                </div>
                <h3 className="title-font text-center text-sm mb-1" style={{color: '#d4af37'}}>{pathway.name}</h3>
                <p className="text-xs text-gray-400 text-center">{pathway.desc}</p>
              </div>
            ))}
          </div>

          {selectedPathway && (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90" onClick={() => setSelectedPathway(null)}>
              <div className="glass rounded-2xl p-8 max-w-lg w-full" onClick={e => e.stopPropagation()}>
                <h2 className="text-3xl title-font mb-4" style={{color: '#d4af37'}}>{selectedPathway.name}</h2>
                <p className="text-gray-300 mb-6">{selectedPathway.desc}</p>
                <div className="space-y-3">
                  <button 
                    onClick={() => selectPathway(selectedPathway.id)}
                    disabled={selecting}
                    className="w-full px-6 py-3 bg-yellow-600 text-black font-bold rounded-lg hover:bg-yellow-500 disabled:opacity-50"
                  >
                    {selecting ? 'Selecting...' : 'Select This Pathway'}
                  </button>
                  <button 
                    onClick={() => setSelectedPathway(null)}
                    className="w-full px-6 py-3 border border-gray-600 rounded-lg hover:bg-gray-800"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Games({ user, onRefresh }) {
      const [playing, setPlaying] = useState(null);
      const [reward, setReward] = useState(null);

      const games = [
        { id: 'tarot', name: 'Tarot Divination', icon: 'üÉè', reward: '10-30 points', time: 2 },
        { id: 'acting', name: 'Acting Method', icon: 'üé≠', reward: '15-40 points', time: 3 },
        { id: 'quiz', name: 'LOTM Quiz', icon: 'üìö', reward: '20-50 points', time: 4 },
        { id: 'watch_ad', name: 'Watch Ad', icon: 'üì∫', reward: '50-100 points', time: 30 }
      ];

      const playGame = (game) => {
        if (!user) {
          alert('Please login first!');
          return;
        }

        setPlaying(game);
        setReward(null);

        setTimeout(() => {
          const min = parseInt(game.reward.split('-')[0]);
          const max = parseInt(game.reward.split('-')[1]);
          const points = Math.floor(Math.random() * (max - min + 1)) + min;
          
          setReward(points);
          setPlaying(null);

          // Update user points (simulate)
          setTimeout(() => {
            setReward(null);
            onRefresh();
          }, 3000);
        }, game.time * 1000);
      };

      return (
        <div className="space-y-8">
          <div className="text-center">
            <h2 className="text-4xl title-font mb-4" style={{color: '#d4af37'}}>Mystical Games</h2>
            <p className="text-gray-300">Complete games to earn spiritual points!</p>
          </div>

          {!user && (
            <div className="glass rounded-xl p-8 text-center">
              <div className="text-6xl mb-4">üîí</div>
              <h3 className="text-2xl font-bold mb-4">Login Required</h3>
              <a href="/login" className="inline-block px-8 py-3 bg-yellow-600 text-black font-bold rounded-lg">
                Login Now
              </a>
            </div>
          )}

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {games.map(game => (
              <div key={game.id} className="glass rounded-xl p-6 text-center">
                <div className="text-6xl mb-4">{game.icon}</div>
                <h3 className="text-xl title-font mb-2" style={{color: '#d4af37'}}>{game.name}</h3>
                <p className="text-sm text-gray-400 mb-2">Reward: {game.reward}</p>
                <p className="text-xs text-gray-500 mb-4">Time: {game.time}s</p>
                {user && (
                  <button
                    onClick={() => playGame(game)}
                    disabled={playing}
                    className="w-full px-4 py-2 bg-yellow-600 text-black font-bold rounded-lg hover:bg-yellow-500 disabled:opacity-50"
                  >
                    {playing?.id === game.id ? 'Playing...' : 'Play'}
                  </button>
                )}
              </div>
            ))}
          </div>

          {reward && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90">
              <div className="glass rounded-2xl p-12 text-center">
                <div className="text-8xl mb-6">‚ú®</div>
                <h2 className="text-4xl title-font mb-4" style={{color: '#d4af37'}}>
                  +{reward} Points!
                </h2>
                <p className="text-gray-300">Spiritual points earned!</p>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Beyonders({ beyonders, getDiscordAvatar }) {
      const [search, setSearch] = useState('');
      const filtered = beyonders.filter(b =>
        b.username?.toLowerCase().includes(search.toLowerCase()) ||
        b.pathway?.toLowerCase().includes(search.toLowerCase())
      );

      return (
        <div className="space-y-8">
          <div className="text-center">
            <h2 className="text-4xl title-font mb-4" style={{color: '#d4af37'}}>
              All Beyonders ({beyonders.length})
            </h2>
            <input
              type="text"
              placeholder="üîç Search..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="max-w-md w-full px-6 py-3 rounded-lg glass border border-yellow-600/30 outline-none"
            />
          </div>

          {filtered.length === 0 ? (
            <div className="text-center py-20">
              <div className="text-6xl mb-4">üë•</div>
              <p className="text-xl text-gray-400">
                {search ? 'No beyonders found' : 'No beyonders yet. Be the first!'}
              </p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {filtered.map(b => (
                <div key={b.user_id} className="glass rounded-xl p-6">
                  <div className="flex items-center gap-4 mb-4">
                    <img 
                      src={getDiscordAvatar(b.user_id, b.avatar)} 
                      alt={b.username}
                      className="profile-img"
                    />
                    <div>
                      <h3 className="font-bold">{b.username}</h3>
                      {b.sequence === 0 && <span className="text-xs bg-red-500 px-2 py-1 rounded">‚öúÔ∏è GOD</span>}
                      {b.sequence <= 3 && b.sequence > 0 && <span className="text-xs bg-yellow-500 text-black px-2 py-1 rounded">üëº ANGEL</span>}
                    </div>
                  </div>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span>Pathway:</span>
                      <span className="capitalize" style={{color: '#d4af37'}}>{b.pathway || 'None'}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Sequence:</span>
                      <span style={{color: '#d4af37'}}>{b.sequence}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Points:</span>
                      <span style={{color: '#d4af37'}}>{b.spiritual_points || 0}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function StatCard({ icon, title, value }) {
      return (
        <div className="glass rounded-xl p-6 text-center transition-all duration-300 hover:scale-105">
          <div className="text-5xl mb-3">{icon}</div>
          <div className="text-gray-400 text-sm mb-1">{title}</div>
          <div className="text-3xl font-bold" style={{color: '#d4af37'}}>{value}</div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

</body>
</html>
